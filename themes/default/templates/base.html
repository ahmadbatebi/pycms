<!DOCTYPE html>
<html lang="{{ cms.current_language }}" dir="{{ cms.lang_direction }}"{% block html_attrs %}{% endblock %}>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>{{ cms.site_title }} - {{ cms.page_title }}</title>

    <meta name="description" content="{{ cms.page_description }}">
    <meta name="keywords" content="{{ cms.page_keywords }}">

    <link rel="stylesheet" href="{{ cms.asset('css/style.css') }}">
    {% block theme_css %}{% endblock %}
    <link rel="stylesheet" href="{{ cms.asset('css/blog.css') }}">
    {% if cms.lang_direction == 'rtl' %}
    <link rel="stylesheet" href="{{ cms.asset('css/rtl.css') }}">
    {% endif %}

    {{ cms.admin_css | safe }}
</head>
<body{% block body_class %}{% endblock %}>
    <header class="site-header">
        <div class="container">
            <a href="/" class="site-title">{% if cms.blocks.header %}{{ cms.blocks.header | safe }}{% else %}{{ cms.site_title }}{% endif %}</a>
            <div class="header-right">
                <nav class="main-nav">
                    <ul>
                        {% for item in cms.menu_items %}
                        <li>
                            <a href="/{{ item.slug }}"
                               {% if item.slug == cms.page_slug %}class="active"{% endif %}>
                                {{ item.name }}
                            </a>
                        </li>
                        {% endfor %}
                        {% if cms.user %}
                        <li class="user-menu">
                            <a href="/profile/{{ cms.user }}" class="user-profile-link">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                                <span>{{ cms.user_display_name or cms.user }}</span>
                            </a>
                        </li>
                        <li>
                            <a href="/logout" class="logout-link">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                    <polyline points="16 17 21 12 16 7"></polyline>
                                    <line x1="21" y1="12" x2="9" y2="12"></line>
                                </svg>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% if cms.available_languages|length > 1 %}
                <div class="language-switcher">
                    {% for lang in cms.available_languages %}
                    <a href="{{ cms.lang_url(lang.code) }}"
                       class="lang-link{% if lang.code == cms.current_language %} active{% endif %}"
                       title="{{ lang.name }}">
                        {% if lang.code == 'fa' %}
                        {# Lion and Sun for Persian #}
                        <img src="{{ cms.asset('img/lion-sun.svg') }}" alt="فارسی" width="24" height="18" class="lang-flag">
                        {% elif lang.code == 'en' %}
                        {# UK Flag for English #}
                        <svg viewBox="0 0 60 30" width="24" height="18" class="lang-flag"><clipPath id="uk-s"><path d="M0,0 v30 h60 v-30 z"/></clipPath><clipPath id="uk-t"><path d="M30,15 h30 v15 z v15 h-30 z h-30 v-15 z v-15 h30 z"/></clipPath><g clip-path="url(#uk-s)"><path d="M0,0 v30 h60 v-30 z" fill="#012169"/><path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/><path d="M0,0 L60,30 M60,0 L0,30" clip-path="url(#uk-t)" stroke="#C8102E" stroke-width="4"/><path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10"/><path d="M30,0 v30 M0,15 h60" stroke="#C8102E" stroke-width="6"/></g></svg>
                        {% else %}
                        {{ lang.native_name }}
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
                {% if cms.search_enabled %}
                <button type="button" class="search-toggle" id="searchToggle" aria-label="Search" title="Search (Ctrl+K)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
                {% endif %}
            </div>
        </div>
    </header>

    <main class="site-main">
        <div class="container">
            <div class="main-layout{% if cms.blocks.sidebar %} has-sidebar{% endif %}">
                <div class="main-content">
                    {% block content %}
                    <article class="page-content">
                        {% if not cms.hide_title %}
                        <h1>{{ cms.page_title }}</h1>
                        {% endif %}
                        {{ cms.page_content | safe }}
                    </article>

                    {% if cms.blog_posts or cms.blog_total_posts > 0 %}
                    <section class="blog-posts-widget{% if cms.hide_title %} no-page-header{% endif %}">
                        <h2>{{ _('Latest Posts') if _ else 'Latest Posts' }}</h2>
                        <div class="blog-posts blog-posts-{{ cms.blog_columns }}col">
                            {% for post in cms.blog_posts %}
                            <article class="blog-post-card">
                                {% if post.featured_image %}
                                <img src="/uploads/{{ post.featured_image }}" alt="{{ post.title }}" class="post-thumbnail">
                                {% endif %}
                                <div class="post-content">
                                    {% if post.category %}
                                    <span class="post-category">{{ post.category }}</span>
                                    {% endif %}
                                    <h2><a href="/blog/{{ post.slug }}">{{ post.title }}</a></h2>
                                    {% if post.excerpt %}
                                    <p class="post-excerpt">{{ post.excerpt }}</p>
                                    {% endif %}
                                    <div class="post-meta">
                                        <span class="post-author">{{ post.author }}</span>
                                        <span class="post-date">{{ post.published_at | jalali_date(cms.current_language) }}</span>
                                    </div>
                                </div>
                            </article>
                            {% endfor %}
                        </div>
                        {% if cms.blog_total_pages > 1 %}
                        <nav class="pagination">
                            {% if cms.blog_current_page > 1 %}
                            <a href="?blog_page={{ cms.blog_current_page - 1 }}" class="prev">&laquo; {{ _('Previous') if _ else 'Previous' }}</a>
                            {% endif %}
                            {% for p in range(1, cms.blog_total_pages + 1) %}
                                {% if p == cms.blog_current_page %}
                                <span class="current">{{ p }}</span>
                                {% else %}
                                <a href="?blog_page={{ p }}">{{ p }}</a>
                                {% endif %}
                            {% endfor %}
                            {% if cms.blog_current_page < cms.blog_total_pages %}
                            <a href="?blog_page={{ cms.blog_current_page + 1 }}" class="next">{{ _('Next') if _ else 'Next' }} &raquo;</a>
                            {% endif %}
                        </nav>
                        {% endif %}
                    </section>
                    {% endif %}
                    {% endblock %}
                </div>
                {% if cms.blocks.sidebar %}
                <aside class="site-sidebar">
                    {{ cms.blocks.sidebar | safe }}
                </aside>
                {% endif %}
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            {{ cms.blocks.footer | safe }}
        </div>
    </footer>

    {{ cms.admin_js | safe }}

    {% if cms.search_enabled %}
    <!-- Search Modal -->
    <div id="searchModal" class="search-modal" role="dialog" aria-modal="true" aria-labelledby="searchModalTitle">
        <div class="search-modal-backdrop" id="searchBackdrop"></div>
        <div class="search-modal-content">
            <div class="search-modal-header">
                <div class="search-input-wrapper">
                    <svg class="search-input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text"
                           id="searchInput"
                           class="search-input"
                           placeholder="{{ cms.search_placeholder }}"
                           autocomplete="off"
                           autocapitalize="off"
                           spellcheck="false">
                    <div class="search-loading" id="searchLoading">
                        <svg class="spinner" viewBox="0 0 24 24" width="20" height="20">
                            <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="3" stroke-dasharray="30 70"></circle>
                        </svg>
                    </div>
                    <kbd class="search-kbd">ESC</kbd>
                </div>
                <button type="button" class="search-close" id="searchClose" aria-label="Close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6 6 18M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="search-modal-body" id="searchResults">
                <div class="search-empty" id="searchEmpty">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.4">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <p>{{ cms.search_hint }}</p>
                </div>
                <div class="search-results-list" id="searchResultsList"></div>
                <div class="search-no-results" id="searchNoResults" style="display:none;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.4">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                        <path d="M8 8l6 6M14 8l-6 6"></path>
                    </svg>
                    <p>{{ cms.search_no_results }}</p>
                </div>
            </div>
            <div class="search-modal-footer">
                <div class="search-shortcuts">
                    <span><kbd>↑</kbd><kbd>↓</kbd> {{ cms.search_navigate }}</span>
                    <span><kbd>Enter</kbd> {{ cms.search_select }}</span>
                    <span><kbd>ESC</kbd> {{ cms.search_close }}</span>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Search Toggle Button */
        .search-toggle {
            background: transparent;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .search-toggle:hover {
            background: rgba(0,0,0,0.1);
        }

        /* Search Modal */
        .search-modal {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 10vh;
        }
        .search-modal.active {
            display: flex;
        }
        .search-modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        .search-modal-content {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 1rem;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            overflow: hidden;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
        }

        /* Search Header */
        .search-modal-header {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            gap: 0.75rem;
        }
        .search-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
        }
        .search-input-icon {
            color: #9ca3af;
            flex-shrink: 0;
        }
        .search-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 1.125rem;
            padding: 0.5rem 0;
            background: transparent;
        }
        .search-input::placeholder {
            color: #9ca3af;
        }
        .search-loading {
            display: none;
        }
        .search-loading.active {
            display: block;
        }
        .search-loading .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .search-kbd {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 0.125rem 0.375rem;
            font-size: 0.75rem;
            color: #6b7280;
            font-family: inherit;
        }
        .search-close {
            background: transparent;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            border-radius: 6px;
        }
        .search-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        /* Search Body */
        .search-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        .search-empty, .search-no-results {
            text-align: center;
            padding: 2rem 1rem;
            color: #6b7280;
        }
        .search-empty p, .search-no-results p {
            margin: 1rem 0 0;
        }

        /* Search Results */
        .search-result-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            text-decoration: none;
            color: inherit;
            transition: background-color 0.15s;
        }
        .search-result-item:hover,
        .search-result-item.active {
            background: #f3f4f6;
        }
        .search-result-icon {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e5e7eb;
            border-radius: 8px;
            color: #6b7280;
        }
        .search-result-icon.page { background: #dbeafe; color: #2563eb; }
        .search-result-icon.blog { background: #dcfce7; color: #16a34a; }
        .search-result-content {
            flex: 1;
            min-width: 0;
        }
        .search-result-title {
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .search-result-title mark {
            background: #fef08a;
            color: inherit;
            padding: 0 2px;
            border-radius: 2px;
        }
        .search-result-excerpt {
            font-size: 0.875rem;
            color: #6b7280;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .search-result-excerpt mark {
            background: #fef9c3;
            color: inherit;
        }
        .search-result-meta {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }
        .search-result-type {
            display: inline-block;
            padding: 0.125rem 0.375rem;
            background: #f3f4f6;
            border-radius: 4px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Search Footer */
        .search-modal-footer {
            padding: 0.75rem 1rem;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        .search-shortcuts {
            display: flex;
            gap: 1.5rem;
            font-size: 0.75rem;
            color: #6b7280;
            justify-content: center;
            flex-wrap: wrap;
        }
        .search-shortcuts kbd {
            background: #fff;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 0.125rem 0.375rem;
            font-size: 0.7rem;
            margin: 0 0.125rem;
        }

        /* RTL Support */
        [dir="rtl"] .search-modal-header {
            flex-direction: row-reverse;
        }
        [dir="rtl"] .search-input-wrapper {
            flex-direction: row-reverse;
        }
        [dir="rtl"] .search-input {
            text-align: right;
        }
        [dir="rtl"] .search-result-item {
            flex-direction: row-reverse;
        }
        [dir="rtl"] .search-shortcuts {
            flex-direction: row-reverse;
        }

        /* Dark mode support for search (applies to dark template) */
        .template-dark .search-modal-content {
            background: #1f2937;
        }
        .template-dark .search-modal-header {
            border-color: #374151;
        }
        .template-dark .search-input {
            color: #f9fafb;
        }
        .template-dark .search-input::placeholder {
            color: #6b7280;
        }
        .template-dark .search-kbd {
            background: #374151;
            border-color: #4b5563;
            color: #9ca3af;
        }
        .template-dark .search-close:hover {
            background: #374151;
            color: #f9fafb;
        }
        .template-dark .search-result-item:hover,
        .template-dark .search-result-item.active {
            background: #374151;
        }
        .template-dark .search-result-title {
            color: #f9fafb;
        }
        .template-dark .search-result-excerpt {
            color: #9ca3af;
        }
        .template-dark .search-modal-footer {
            background: #111827;
            border-color: #374151;
        }
        .template-dark .search-shortcuts kbd {
            background: #374151;
            border-color: #4b5563;
        }
        .template-dark .search-empty,
        .template-dark .search-no-results {
            color: #9ca3af;
        }

        /* Mobile adjustments */
        @media (max-width: 640px) {
            .search-modal {
                padding-top: 0;
            }
            .search-modal-content {
                max-height: 100vh;
                border-radius: 0;
                margin: 0;
            }
            .search-modal-footer {
                display: none;
            }
        }
    </style>

    <div id="searchConfig"
         data-type-page="{{ cms.search_type_page }}"
         data-type-blog="{{ cms.search_type_blog }}">
    </div>
    <script src="{{ cms.asset('js/search.js') }}" defer></script>
    {% endif %}

    {% if cms.jump_to_top_enabled %}
    <!-- Jump to Top Button -->
    <button type="button" class="jump-to-top" id="jumpToTop" aria-label="Back to top" title="Back to top">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 15l-6-6-6 6"/>
        </svg>
    </button>

    <style>
        .jump-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--color-primary, #2563eb);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease, background-color 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }
        .jump-to-top.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .jump-to-top:hover {
            background: var(--color-primary-dark, #1d4ed8);
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }
        .jump-to-top:active {
            transform: translateY(0);
        }

        /* RTL Support */
        [dir="rtl"] .jump-to-top {
            right: auto;
            left: 2rem;
        }

        /* Mobile adjustments */
        @media (max-width: 640px) {
            .jump-to-top {
                bottom: 1.5rem;
                right: 1.5rem;
                width: 44px;
                height: 44px;
            }
            [dir="rtl"] .jump-to-top {
                right: auto;
                left: 1.5rem;
            }
        }
    </style>

    <script src="{{ cms.asset('js/jump-to-top.js') }}" defer></script>
    {% endif %}
</body>
</html>
